{% extends "base.html" %}
{% block title %}Planes de Suscripci√≥n ¬∑ BIM{% endblock %}

{% block content %}

<!-- CARGA EL SDK DE PAYPAL UNA VEZ -->
<script src="https://www.paypal.com/sdk/js?client-id=AcNPU-Pvmt2C7pjnTj38a3JP67D6zW76Do_gz4T_E9MOsgJYuFyoa_21_dsrYxUtlEWS0Rh9-bPPHmZf&vault=true&intent=subscription"></script>

<section class="suscripcion">
  <h2>Planes de Suscripci√≥n</h2>
  <p class="suscripcion-desc">
    Apoya el desarrollo del proyecto con una peque√±a contribuci√≥n mensual üíö<br>
    Elige el plan que mejor se adapte a ti.
  </p>

  <div class="suscripcion-cards">

    <!-- PLAN GRATIS -->
    <div class="plan-card">
      <h3>Gratis</h3>
      <p class="precio">0 <span>USD/mes</span></p>
      <ul>
        <li>Acceso limitado</li>
        <li>Conversi√≥n b√°sica</li>
        <li class="negativo">Sin funciones premium</li>
      </ul>
      <a href="/suscripcion/gratis">
        <button>Usar Gratis</button>
      </a>
    </div>

    <!-- PLAN CON DESPLEGABLE PARA BASICO / PREMIUM -->
    <div class="plan-card">
      <h3>Suscripci√≥n Pagada</h3>
      <label for="plan-selector">Elige tu plan:</label>
      <select id="plan-selector">
        <option value="P-2K6973181R3291153NENZEIA">B√°sico - $0.01/mes</option>
        <option value="P-2B842033E5190021MNENZOVQ">Premium - $0.02/mes</option>
      </select>

      <ul id="plan-benefits">
        <li>Acceso a funciones est√°ndar</li>
        <li>Soporte b√°sico por correo</li>
        <li class="negativo">Conversi√≥n simult√°nea limitada</li>
      </ul>

      <div id="paypal-button-container"></div>
    </div>

  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const planSelector = document.getElementById("plan-selector");
  const planBenefits = document.getElementById("plan-benefits");

  // Funci√≥n para actualizar beneficios seg√∫n plan
  function actualizarBeneficios() {
    const plan = planSelector.value;
    if(plan === "P-2K6973181R3291153NENZEIA") {
      planBenefits.innerHTML = `
        <li>Acceso a funciones est√°ndar</li>
        <li>Soporte b√°sico por correo</li>
        <li class="negativo">Conversi√≥n simult√°nea limitada</li>
      `;
    } else if(plan === "P-2B842033E5190021MNENZOVQ") {
      planBenefits.innerHTML = `
        <li>Conversi√≥n ilimitada</li>
        <li>Sin anuncios ni restricciones</li>
        <li>Soporte prioritario</li>
      `;
    }
  }

  planSelector.addEventListener("change", actualizarBeneficios);

  // Inicializar bot√≥n PayPal
  let currentPlan = planSelector.value;

  function renderPayPalButton(planId) {
    document.getElementById("paypal-button-container").innerHTML = "";
    paypal.Buttons({
      style: { shape: 'pill', color: 'white', layout: 'horizontal', label: 'subscribe' },
      createSubscription: function(data, actions) {
       return actions.subscription.create({
    plan_id: planId,
    custom_id: "{{ current_user.id }}"
});

      },
      onApprove: function(data) {
  const subscriptionID = data.subscriptionID;
  const planID = currentPlan; // valor del <select>

  fetch("/suscripcion/confirmar", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      subscriptionID: subscriptionID,
      planID: planID
    })
  })
  .then(resp => resp.json())
  .then(info => {
    if (info.ok) {
      alert("‚úÖ Suscripci√≥n registrada correctamente. Plan activo: " + info.plan);
      window.location.href = "{{ url_for('perfil') }}";
    } else {
      console.error("Error al registrar suscripci√≥n:", info);
      alert("La suscripci√≥n se cre√≥ en PayPal, pero hubo un problema al guardarla en el sistema.");
    }
  })
  .catch(err => {
    console.error("Error al llamar /suscripcion/confirmar:", err);
    alert("Ocurri√≥ un error al registrar la suscripci√≥n en el sistema.");
  });
}

    }).render('#paypal-button-container');
  }

  // Renderizar bot√≥n inicial
  renderPayPalButton(currentPlan);

  // Cambiar bot√≥n al seleccionar otro plan
  planSelector.addEventListener("change", function() {
    currentPlan = this.value;
    renderPayPalButton(currentPlan);
  });

});
</script>

{% endblock %}
